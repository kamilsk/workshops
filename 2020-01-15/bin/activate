#!/usr/bin/env bash

deactivate () {
    if [[ -n "${_OLD_PATH:-}" ]]; then
        export PATH="${_OLD_PATH:-}"
        unset _OLD_PATH
    fi

    if [[ -n "${BASH:-}" || -n "${ZSH_VERSION:-}" ]]; then
        hash -r
    fi

    if [[ -n "${_OLD_PS1:-}" ]]; then
        PS1="${_OLD_PS1:-}"
        export PS1
        unset _OLD_PS1
    fi

    if [[ ! "${1:-}" = "nondestructive" ]]; then
        unset -f deactivate
        unset -f build
        unset -f case-1
        unset -f case-2
        unset -f case-3
        unset -f clean
        unset -f realpath
    fi

    unset BINPATH
    unset ROOT
}

build () {
    docker build -f "${ROOT}"/case-1/Dockerfile \
                 -t 2020-01-15:case-1 \
                 --force-rm --no-cache --pull --rm \
                 "${ROOT}"/case-1
}

case-1 () {
    docker run --rm -it \
               -v "${ROOT}"/case-1/project:/app \
               -v "${ROOT}"/case-1/patches:/git \
               2020-01-15:case-1 bash
}

case-2 () {
    docker run --rm -it \
               -v "${ROOT}"/case-2/project:/app \
               -v "${ROOT}"/case-2/patches:/git \
               2020-01-15:case-2 bash
}

case-3 () {
    docker run --rm -it \
               -v "${ROOT}"/case-3/project:/app \
               -v "${ROOT}"/case-3/patches:/git \
               2020-01-15:case-3 bash
}

clean () {
    git reset --hard && git clean -df
}

realpath () {
    if [[ -z "${1:-}" ]]; then
        echo 'Please provide a file/dir name'
        return
    fi
    echo "$(cd `dirname ${1}` && pwd)/${1}"
}

deactivate nondestructive

_OLD_PATH="${PATH}"
export BINPATH=$(realpath $(dirname $0))
export PATH="${BINPATH}:${PATH}"
export ROOT=$(dirname $(realpath $(dirname $0)))/

if [[ -z "${BINPATH_DISABLE_PROMPT:-}" ]]; then
    _OLD_PS1="${PS1:-}"
    if [[ "x(activated) " != x ]]; then
        PS1="(activated) ${PS1:-}"
    elif [[ "`basename \"$BINPATH\"`" = "__" ]]; then
        PS1="[`basename \`dirname \"$BINPATH\"\``] $PS1"
    else
        PS1="(`basename \"$BINPATH\"`)$PS1"
    fi
    export PS1
fi

if [[ -n "${BASH:-}" || -n "${ZSH_VERSION:-}" ]]; then
    hash -r
fi
